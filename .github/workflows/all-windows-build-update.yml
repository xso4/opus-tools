name: All Windows Build Update

on:
  workflow_dispatch:

jobs:
  # 1. Build FLAC Dependencies (Ogg, FLAC)
  deps-flac:
    name: FLAC Deps (${{ matrix.type }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        type: [Static, Dynamic]
        include:
          - type: Static
            shared: OFF
            runtime: MultiThreaded
            config: Release
          - type: Dynamic
            shared: ON
            runtime: MultiThreadedDLL
            config: Release

    steps:
      - name: Checkout Ogg
        uses: actions/checkout@v4
        with:
          repository: xiph/ogg
          path: ogg

      - name: Checkout FLAC
        uses: actions/checkout@v4
        with:
          repository: xiph/flac
          path: flac

      - name: Build Ogg
        shell: cmd
        run: |
          cmake -S ogg -B build_ogg -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=${{ matrix.shared }} ^
            -DCMAKE_MSVC_RUNTIME_LIBRARY=${{ matrix.runtime }} ^
            -DCMAKE_INSTALL_PREFIX=install_ogg
          cmake --build build_ogg --config Release --parallel
          cmake --install build_ogg --config Release

      - name: Build FLAC
        shell: cmd
        run: |
          cmake -S flac -B build_flac -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=${{ matrix.shared }} ^
            -DCMAKE_MSVC_RUNTIME_LIBRARY=${{ matrix.runtime }} ^
            -DCMAKE_INSTALL_PREFIX=install_flac ^
            -DCMAKE_PREFIX_PATH=%GITHUB_WORKSPACE%\install_ogg
          cmake --build build_flac --config Release --parallel
          cmake --install build_flac --config Release

      - name: Prepare Artifacts
        shell: cmd
        run: |
          mkdir dist\flac
          mkdir dist\ogg
          xcopy /E /I /Y install_flac dist\flac
          xcopy /E /I /Y install_ogg dist\ogg

      - name: Upload FLAC Deps
        uses: actions/upload-artifact@v4
        with:
          name: flac-deps-${{ matrix.type }}
          path: dist/

  # 2. Build Opus Dependencies (Ogg, Opus, Libopusenc, Opusfile)
  deps-opus:
    name: Opus Deps (${{ matrix.type }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        type: [Static, Dynamic]
        include:
          - type: Static
            shared: OFF
            runtime: MultiThreaded
            msvc_conf: Release
          - type: Dynamic
            shared: ON
            runtime: MultiThreadedDLL
            msvc_conf: ReleaseDLL

    steps:
      - name: Checkout Ogg
        uses: actions/checkout@v4
        with:
          repository: xiph/ogg
          path: ogg

      - name: Checkout Opus
        uses: actions/checkout@v4
        with:
          repository: xiph/opus
          path: opus

      - name: Checkout Libopusenc
        uses: actions/checkout@v4
        with:
          path: libopusenc

      - name: Checkout Opusfile
        uses: actions/checkout@v4
        with:
          repository: xiph/opusfile
          path: opusfile

      - name: Add MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build Ogg
        shell: cmd
        run: |
          cmake -S ogg -B build_ogg -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=${{ matrix.shared }} ^
            -DCMAKE_MSVC_RUNTIME_LIBRARY=${{ matrix.runtime }} ^
            -DCMAKE_INSTALL_PREFIX=install_ogg
          cmake --build build_ogg --config Release --parallel
          cmake --install build_ogg --config Release

      - name: Build Opus
        shell: cmd
        run: |
          cmake -S opus -B build_opus -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=${{ matrix.shared }} ^
            -DCMAKE_MSVC_RUNTIME_LIBRARY=${{ matrix.runtime }} ^
            -DCMAKE_INSTALL_PREFIX=install_opus
          cmake --build build_opus --config Release --parallel
          cmake --install build_opus --config Release

      - name: Build Libopusenc
        shell: cmd
        run: |
          REM Prepare Opus libs for Libopusenc VS solution
          mkdir opus\win32\VS2015\x64\${{ matrix.msvc_conf }}
          copy build_opus\Release\opus.lib opus\win32\VS2015\x64\${{ matrix.msvc_conf }}\opus.lib
          
          REM Build Libopusenc
          msbuild libopusenc\win32\VS2015\opusenc.sln /m /p:Configuration=${{ matrix.msvc_conf }} /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0

      - name: Build Opusfile
        shell: cmd
        run: |
          cmake -S opusfile -B build_opusfile -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=${{ matrix.shared }} ^
            -DCMAKE_MSVC_RUNTIME_LIBRARY=${{ matrix.runtime }} ^
            -DCMAKE_INSTALL_PREFIX=install_opusfile ^
            -DCMAKE_PREFIX_PATH="%GITHUB_WORKSPACE%\install_ogg;%GITHUB_WORKSPACE%\install_opus" ^
            -DOP_DISABLE_HTTP=ON
          cmake --build build_opusfile --config Release --parallel
          cmake --install build_opusfile --config Release

      - name: Prepare Artifacts
        shell: cmd
        run: |
          mkdir dist\ogg
          mkdir dist\opus
          mkdir dist\opusfile
          mkdir dist\libopusenc
          
          xcopy /E /I /Y install_ogg dist\ogg
          xcopy /E /I /Y install_opus dist\opus
          xcopy /E /I /Y install_opusfile dist\opusfile
          
          REM Collect Libopusenc artifacts manually from VS output
          mkdir dist\libopusenc\lib
          mkdir dist\libopusenc\include
          copy libopusenc\win32\VS2015\x64\${{ matrix.msvc_conf }}\opusenc.lib dist\libopusenc\lib\
          if exist libopusenc\win32\VS2015\x64\${{ matrix.msvc_conf }}\opusenc.dll copy libopusenc\win32\VS2015\x64\${{ matrix.msvc_conf }}\opusenc.dll dist\libopusenc\lib\
          copy libopusenc\include\opusenc.h dist\libopusenc\include\

      - name: Upload Opus Deps
        uses: actions/upload-artifact@v4
        with:
          name: opus-deps-${{ matrix.type }}
          path: dist/

  # 3. Build Opus Tools
  build-tools:
    name: Opus Tools (${{ matrix.type }})
    needs: [deps-flac, deps-opus]
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        type: [Static, Dynamic]
        include:
          - type: Static
            msvc_conf: Release
          - type: Dynamic
            msvc_conf: ReleaseDLL

    steps:
      - name: Checkout Opus Tools
        uses: actions/checkout@v4
        with:
          path: opus-tools

      - name: Add MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Download FLAC Deps
        uses: actions/download-artifact@v4
        with:
          name: flac-deps-${{ matrix.type }}
          path: deps

      - name: Download Opus Deps
        uses: actions/download-artifact@v4
        with:
          name: opus-deps-${{ matrix.type }}
          path: deps

      - name: Organize Dependencies for VS Solution
        shell: cmd
        working-directory: deps
        run: |
          REM We need to restructure the downloaded 'deps' folder to match what opus-tools.sln expects
          REM Expected: ..\..\..\<lib>\win32\VS2015\x64\<Conf>
          
          set CONF=${{ matrix.msvc_conf }}
          
          REM 1. Ogg
          mkdir ogg\win32\VS2015\x64\%CONF%
          REM CMake installs to lib/ogg.lib, VS expects libogg.lib?
          if exist ogg\lib\ogg.lib copy ogg\lib\ogg.lib ogg\win32\VS2015\x64\%CONF%\libogg.lib
          if exist ogg\lib\libogg.lib copy ogg\lib\libogg.lib ogg\win32\VS2015\x64\%CONF%\libogg.lib
          xcopy /E /I /Y ogg\include ogg\include
          
          REM 2. Opus
          mkdir opus\win32\VS2015\x64\%CONF%
          if exist opus\lib\opus.lib copy opus\lib\opus.lib opus\win32\VS2015\x64\%CONF%\opus.lib
          xcopy /E /I /Y opus\include opus\include
          
          REM 3. Libopusenc
          mkdir libopusenc\win32\VS2015\x64\%CONF%
          copy libopusenc\lib\opusenc.lib libopusenc\win32\VS2015\x64\%CONF%\opusenc.lib
          if exist libopusenc\lib\opusenc.dll copy libopusenc\lib\opusenc.dll libopusenc\win32\VS2015\x64\%CONF%\opusenc.dll
          xcopy /E /I /Y libopusenc\include libopusenc\include
          
          REM 4. Opusfile
          mkdir opusfile\win32\VS2015\x64\%CONF%
          if exist opusfile\lib\opusfile.lib copy opusfile\lib\opusfile.lib opusfile\win32\VS2015\x64\%CONF%\opusfile.lib
          xcopy /E /I /Y opusfile\include opusfile\include
          
          REM 5. FLAC
          REM Expected: ..\..\..\flac\objs\$(Platform)\$(Configuration)\lib
          REM Note: opus-tools props says: objs\$(Platform)\$(Configuration)\lib
          REM So we need flac\objs\x64\Release\lib
          mkdir flac\objs\x64\%CONF%\lib
          if exist flac\lib\FLAC.lib copy flac\lib\FLAC.lib flac\objs\x64\%CONF%\lib\libFLAC.lib
          if exist flac\lib\libFLAC.lib copy flac\lib\libFLAC.lib flac\objs\x64\%CONF%\lib\libFLAC.lib
          xcopy /E /I /Y flac\include flac\include

      - name: Patch Project Files (Remove OpenSSL)
        shell: powershell
        working-directory: opus-tools
        run: |
          # Remove libeay32.lib and ssleay32.lib from Linker dependencies
          $files = Get-ChildItem -Recurse -Filter "*.vcxproj"
          foreach ($file in $files) {
            (Get-Content $file.FullName) -replace 'libeay32.lib;', '' -replace 'ssleay32.lib;', '' -replace 'ws2_32.lib;', '' -replace 'crypt32.lib;', '' | Set-Content $file.FullName
          }

      - name: Build Opus Tools
        shell: cmd
        working-directory: opus-tools
        run: |
          REM Move deps so they are peers of opus-tools directory
          move ..\deps\ogg ..\ogg
          move ..\deps\opus ..\opus
          move ..\deps\libopusenc ..\libopusenc
          move ..\deps\opusfile ..\opusfile
          move ..\deps\flac ..\flac
          
          msbuild win32\VS2015\opus-tools.sln /m /p:Configuration=${{ matrix.msvc_conf }} /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0

      - name: Collect Output
        shell: cmd
        working-directory: opus-tools
        run: |
          mkdir dist
          copy win32\VS2015\x64\${{ matrix.msvc_conf }}\*.exe dist\
          if exist win32\VS2015\x64\${{ matrix.msvc_conf }}\*.dll copy win32\VS2015\x64\${{ matrix.msvc_conf }}\*.dll dist\

      - name: Upload Opus Tools
        uses: actions/upload-artifact@v4
        with:
          name: opus-tools-${{ matrix.type }}
          path: opus-tools/dist/
