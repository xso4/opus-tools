name: Build All Windows

on:
  workflow_dispatch:

jobs:
  build:
    name: Build All ${{ matrix.config }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [static, dynamic]
        include:
          - config: static
            configure_args: --enable-static --disable-shared
            ldflags: -static -static-libgcc -static-libstdc++
            cflags: -O2 -DFLAC__NO_DLL
            pkg_config_cmd: pkg-config --static
          - config: dynamic
            configure_args: --enable-shared --disable-static
            ldflags: ""
            cflags: -O2
            pkg_config_cmd: pkg-config

    steps:
    - uses: actions/checkout@v4
      with:
        path: opus-tools

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          base-devel
          autotools
          git
          mingw-w64-x86_64-toolchain

    - name: Build Dependencies and Tools
      shell: msys2 {0}
      run: |
        # Setup paths
        # We will use a dedicated directory for dependencies to avoid clutter
        mkdir -p deps
        mkdir -p build-all/install
        INSTALL_PREFIX=$(pwd)/build-all/install
        export PKG_CONFIG_PATH=$INSTALL_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH
        export PATH=$INSTALL_PREFIX/bin:$PATH
        export CFLAGS="${{ matrix.cflags }} -I$INSTALL_PREFIX/include"
        export LDFLAGS="${{ matrix.ldflags }} -L$INSTALL_PREFIX/lib"
        export PKG_CONFIG="${{ matrix.pkg_config_cmd }}"
        
        # Common configure arguments
        CONFIG_ARGS="${{ matrix.configure_args }} --prefix=$INSTALL_PREFIX"
        
        echo "Cloning repositories..."
        cd deps
        git clone https://github.com/xiph/ogg.git
        git clone https://github.com/xiph/flac.git
        git clone https://github.com/xiph/opus.git
        git clone https://github.com/xiph/libopusenc.git
        git clone https://github.com/xiph/opusfile.git
        cd ..
        
        # 1. Build Ogg (Base dependency)
        echo "Building Ogg..."
        cd deps/ogg
        ./autogen.sh
        ./configure $CONFIG_ARGS
        make -j$(nproc)
        make install
        cd ../..
        
        # 2. Build Opus and Flac in parallel
        # Flac depends on Ogg (installed in step 1)
        # Opus is independent
        echo "Building Opus and Flac in parallel..."
        
        (
          echo "Starting Opus build..."
          cd deps/opus
          ./autogen.sh
          ./configure $CONFIG_ARGS
          make -j$(nproc)
          make install
          echo "Opus build finished."
        ) &
        OPUS_PID=$!
        
        (
          echo "Starting Flac build..."
          cd deps/flac
          ./autogen.sh
          # Flac needs ogg
          ./configure $CONFIG_ARGS --with-ogg
          make -j$(nproc)
          make install
          echo "Flac build finished."
        ) &
        FLAC_PID=$!
        
        wait $OPUS_PID
        wait $FLAC_PID
        
        # 3. Build libopusenc and opusfile in parallel
        # libopusenc needs Opus
        # opusfile needs Opus and Ogg
        echo "Building libopusenc and opusfile in parallel..."
        
        (
          echo "Starting libopusenc build..."
          cd deps/libopusenc
          ./autogen.sh
          ./configure $CONFIG_ARGS
          make -j$(nproc)
          make install
          echo "libopusenc build finished."
        ) &
        LIBOPUSENC_PID=$!
        
        (
          echo "Starting opusfile build..."
          cd deps/opusfile
          ./autogen.sh
          ./configure $CONFIG_ARGS
          make -j$(nproc)
          make install
          echo "opusfile build finished."
        ) &
        OPUSFILE_PID=$!
        
        wait $LIBOPUSENC_PID
        wait $OPUSFILE_PID
        
        # 4. Build opus-tools (The main project)
        echo "Building opus-tools..."
        cd opus-tools
        ./autogen.sh
        ./configure $CONFIG_ARGS
        make -j$(nproc)
        make install
        
    - name: Copy DLLs (Dynamic only)
      if: matrix.config == 'dynamic'
      shell: msys2 {0}
      run: |
        cd build-all/install/bin
        # Copy Mingw64 DLLs (e.g. libgcc, libwinpthread)
        for exe in *.exe; do
          ldd "$exe" | grep '/mingw64/bin' | awk '{print $3}' | xargs -I {} cp -u {} . || true
        done
        # Note: The DLLs for ogg, opus, etc. are already in this directory because we installed them there.
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: opus-tools-all-windows-${{ matrix.config }}
        path: build-all/install/
