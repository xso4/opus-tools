name: All Windows Build Update

on:
  workflow_dispatch:

jobs:
  # -------------------------------------------------------------------------
  # FLAC Dependencies (Static & Dynamic)
  # -------------------------------------------------------------------------
  flac-static:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            autotools
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            git
      - name: Build Ogg & FLAC (Static)
        shell: msys2 {0}
        run: |
          # Setup paths
          INSTALL_DIR=$(pwd)/install-flac-static
          mkdir -p $INSTALL_DIR
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export PATH=$INSTALL_DIR/bin:$PATH

          # Build Ogg (Static)
          echo "Building Ogg (Static)..."
          cd ogg
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --enable-static --disable-shared
          make -j$(nproc)
          make install
          cd ..

          # Build FLAC (Static)
          echo "Building FLAC (Static)..."
          cd flac
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --enable-static --disable-shared --with-ogg=$INSTALL_DIR
          make -j$(nproc)
          make install
          cd ..

      - name: Upload FLAC Static Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flac-static-deps
          path: install-flac-static

  flac-dynamic:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            autotools
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            git
      - name: Build Ogg & FLAC (Dynamic)
        shell: msys2 {0}
        run: |
          INSTALL_DIR=$(pwd)/install-flac-dynamic
          mkdir -p $INSTALL_DIR
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export PATH=$INSTALL_DIR/bin:$PATH

          # Build Ogg (Dynamic)
          echo "Building Ogg (Dynamic)..."
          cd ogg
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

          # Build FLAC (Dynamic)
          echo "Building FLAC (Dynamic)..."
          cd flac
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --disable-static --enable-shared --with-ogg=$INSTALL_DIR
          make -j$(nproc)
          make install
          cd ..

      - name: Upload FLAC Dynamic Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flac-dynamic-deps
          path: install-flac-dynamic

  # -------------------------------------------------------------------------
  # Opus Dependencies (Static & Dynamic)
  # Includes: ogg, opus, opusfile, libopusenc
  # -------------------------------------------------------------------------
  opus-static:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            autotools
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            git
            mingw-w64-x86_64-openssl
      - name: Build Opus Deps (Static)
        shell: msys2 {0}
        run: |
          INSTALL_DIR=$(pwd)/install-opus-static
          mkdir -p $INSTALL_DIR
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export PATH=$INSTALL_DIR/bin:$PATH

          # Build Ogg (Static) - needed for opusfile
          echo "Building Ogg (Static)..."
          cd ogg
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --enable-static --disable-shared
          make -j$(nproc)
          make install
          cd ..

          # Build Opus (Static)
          echo "Building Opus (Static)..."
          cd opus
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --enable-static --disable-shared
          make -j$(nproc)
          make install
          cd ..

          # Build Opusfile (Static)
          echo "Building Opusfile (Static)..."
          cd opusfile
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --enable-static --disable-shared --disable-http
          make -j$(nproc)
          make install
          cd ..

          # Build libopusenc (Static)
          echo "Building libopusenc (Static)..."
          cd libopusenc
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --enable-static --disable-shared
          make -j$(nproc)
          make install
          cd ..

      - name: Upload Opus Static Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opus-static-deps
          path: install-opus-static

  opus-dynamic:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            autotools
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            git
            mingw-w64-x86_64-openssl
      - name: Build Opus Deps (Dynamic)
        shell: msys2 {0}
        run: |
          INSTALL_DIR=$(pwd)/install-opus-dynamic
          mkdir -p $INSTALL_DIR
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export PATH=$INSTALL_DIR/bin:$PATH

          # Build Ogg (Dynamic)
          echo "Building Ogg (Dynamic)..."
          cd ogg
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

          # Build Opus (Dynamic)
          echo "Building Opus (Dynamic)..."
          cd opus
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

          # Build Opusfile (Dynamic)
          echo "Building Opusfile (Dynamic)..."
          cd opusfile
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --disable-static --enable-shared --disable-http
          make -j$(nproc)
          make install
          cd ..

          # Build libopusenc (Dynamic)
          echo "Building libopusenc (Dynamic)..."
          cd libopusenc
          ./autogen.sh
          ./configure --prefix=$INSTALL_DIR --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

      - name: Upload Opus Dynamic Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opus-dynamic-deps
          path: install-opus-dynamic

  # -------------------------------------------------------------------------
  # Opus Tools (Static & Dynamic)
  # -------------------------------------------------------------------------
  opus-tools-static:
    needs: [flac-static, opus-static]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            autotools
            mingw-w64-x86_64-toolchain
            git
            mingw-w64-x86_64-openssl

      - name: Download FLAC Static Artifacts
        uses: actions/download-artifact@v4
        with:
          name: flac-static-deps
          path: install-deps

      - name: Download Opus Static Artifacts
        uses: actions/download-artifact@v4
        with:
          name: opus-static-deps
          path: install-deps

      - name: Build Opus Tools (Static)
        shell: msys2 {0}
        run: |
          INSTALL_DIR=$(pwd)/install-deps
          OUTPUT_DIR=$(pwd)/opus-tools-static-bin
          mkdir -p $OUTPUT_DIR
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export PATH=$INSTALL_DIR/bin:$PATH

          echo "Building Opus Tools (Static)..."
          cd opus-tools
          ./autogen.sh
          ./configure --prefix=$OUTPUT_DIR --enable-static --disable-shared
          make -j$(nproc)
          make install
          cd ..
          
          # Copy executables for artifact upload
          cp $OUTPUT_DIR/bin/*.exe $OUTPUT_DIR/

      - name: Upload Opus Tools Static
        uses: actions/upload-artifact@v4
        with:
          name: opus-tools-static
          path: opus-tools-static-bin/*.exe

  opus-tools-dynamic:
    needs: [flac-dynamic, opus-dynamic]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            autotools
            mingw-w64-x86_64-toolchain
            git
            mingw-w64-x86_64-openssl

      - name: Download FLAC Dynamic Artifacts
        uses: actions/download-artifact@v4
        with:
          name: flac-dynamic-deps
          path: install-deps

      - name: Download Opus Dynamic Artifacts
        uses: actions/download-artifact@v4
        with:
          name: opus-dynamic-deps
          path: install-deps

      - name: Build Opus Tools (Dynamic)
        shell: msys2 {0}
        run: |
          INSTALL_DIR=$(pwd)/install-deps
          OUTPUT_DIR=$(pwd)/opus-tools-dynamic-bin
          mkdir -p $OUTPUT_DIR
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export PATH=$INSTALL_DIR/bin:$PATH

          echo "Building Opus Tools (Dynamic)..."
          cd opus-tools
          ./autogen.sh
          ./configure --prefix=$OUTPUT_DIR --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

          # Copy executables and DLLs for artifact upload
          cp $OUTPUT_DIR/bin/*.exe $OUTPUT_DIR/
          cp $INSTALL_DIR/bin/*.dll $OUTPUT_DIR/

      - name: Upload Opus Tools Dynamic
        uses: actions/upload-artifact@v4
        with:
          name: opus-tools-dynamic
          path: opus-tools-dynamic-bin/*
