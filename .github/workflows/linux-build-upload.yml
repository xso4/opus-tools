name: Linux MinGW Build Upload

on:
  schedule:
    - cron: '32 18 15 * *'
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      upstream_updated: ${{ steps.check.outputs.upstream_updated }}
      ogg_hash: ${{ steps.check.outputs.ogg_hash }}
      flac_hash: ${{ steps.check.outputs.flac_hash }}
      opus_hash: ${{ steps.check.outputs.opus_hash }}
      libopusenc_hash: ${{ steps.check.outputs.libopusenc_hash }}
      opusfile_hash: ${{ steps.check.outputs.opusfile_hash }}
      opus_tools_hash: ${{ steps.check.outputs.opus_tools_hash }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Check Upstream
        id: check
        run: python .github/scripts/upstream_manager.py
        
      - name: Upload version file
        uses: actions/upload-artifact@v4
        with:
          name: upstream-version
          path: .github/upstream-version.json

  build-flac-deps:
    name: Build Flac Deps
    needs: check-upstream
    if: needs.check-upstream.outputs.upstream_updated == 'true' || github.event_name != 'schedule'
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      PREFIX: ${{ github.workspace }}/mingw/static
      SRC_DIR: ${{ github.workspace }}/_deps/static
      PKG_CONFIG_PATH: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      PKG_CONFIG_LIBDIR: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      SHARED_FLAGS: --enable-static --disable-shared
      CFLAGS: -O2 -DFLAC__NO_DLL
      LDFLAGS: -static -static-libgcc -static-libstdc++

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool libtool-bin pkg-config make mingw-w64 git gettext

      - name: Fetch dependency sources
        run: |
          set -eux
          mkdir -p "$SRC_DIR"
          cd "$SRC_DIR"
          git clone https://gitlab.xiph.org/xiph/ogg.git
          git -C ogg checkout ${{ needs.check-upstream.outputs.ogg_hash }}
          git clone https://gitlab.xiph.org/xiph/flac.git
          git -C flac checkout ${{ needs.check-upstream.outputs.flac_hash }}

      - name: Build libogg
        run: |
          set -eux
          cd "$SRC_DIR/ogg"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build flac
        run: |
          set -eux
          cd "$SRC_DIR/flac"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Upload flac deps
        uses: actions/upload-artifact@v4
        with:
          name: flac-deps
          path: ${{ env.PREFIX }}

  build-opus-deps:
    name: Build Opus Deps
    needs: check-upstream
    if: needs.check-upstream.outputs.upstream_updated == 'true' || github.event_name != 'schedule'
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      PREFIX: ${{ github.workspace }}/mingw/static
      SRC_DIR: ${{ github.workspace }}/_deps/static
      PKG_CONFIG_PATH: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      PKG_CONFIG_LIBDIR: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      SHARED_FLAGS: --enable-static --disable-shared
      CFLAGS: -O2 -DFLAC__NO_DLL
      LDFLAGS: -static -static-libgcc -static-libstdc++

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool libtool-bin pkg-config make mingw-w64 git gettext

      - name: Fetch dependency sources
        run: |
          set -eux
          mkdir -p "$SRC_DIR"
          cd "$SRC_DIR"
          git clone https://gitlab.xiph.org/xiph/ogg.git
          git -C ogg checkout ${{ needs.check-upstream.outputs.ogg_hash }}
          git clone https://gitlab.xiph.org/xiph/opus.git
          git -C opus checkout ${{ needs.check-upstream.outputs.opus_hash }}
          git clone https://gitlab.xiph.org/xiph/opusfile.git
          git -C opusfile checkout ${{ needs.check-upstream.outputs.opusfile_hash }}
          git clone https://gitlab.xiph.org/xiph/libopusenc.git
          git -C libopusenc checkout ${{ needs.check-upstream.outputs.libopusenc_hash }}

      - name: Build libogg
        run: |
          set -eux
          cd "$SRC_DIR/ogg"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build opus
        run: |
          set -eux
          cd "$SRC_DIR/opus"
          ./update_version
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build opusfile
        run: |
          set -eux
          cd "$SRC_DIR/opusfile"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            --disable-http \
            --disable-doc \
            --disable-examples \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build libopusenc
        run: |
          set -eux
          cd "$SRC_DIR/libopusenc"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Upload opus deps
        uses: actions/upload-artifact@v4
        with:
          name: opus-deps
          path: ${{ env.PREFIX }}

  build-opus-docs:
    name: Build Opus Docs
    needs: check-upstream
    if: needs.check-upstream.outputs.upstream_updated == 'true' || github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: xiph/opus
          path: opus
          ref: ${{ needs.check-upstream.outputs.opus_hash }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz pandoc groff

      - name: Configure
        working-directory: opus
        run: |
          ./autogen.sh
          ./configure

      - name: Build Documentation
        working-directory: opus
        run: |
          make -C doc
          mkdir -p doc/txt doc/md
          for f in doc/man/man3/*.3; do
            filename=$(basename "$f" .3)
            pandoc -f man -t plain "$f" -o "doc/txt/${filename}.txt"
            pandoc -f man -t markdown "$f" -o "doc/md/${filename}.md"
          done

      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: opus-docs
          path: |
            opus/doc/html/
            opus/doc/txt/
            opus/doc/md/

  build-opus-tools:
    name: Build Opus Tools
    needs: [build-flac-deps, build-opus-deps, check-upstream]
    if: needs.check-upstream.outputs.upstream_updated == 'true' || github.event_name != 'schedule'
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      PREFIX: ${{ github.workspace }}/mingw/static
      PKG_CONFIG_PATH: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      PKG_CONFIG_LIBDIR: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      SHARED_FLAGS: --enable-static --disable-shared
      CFLAGS: -O2 -DFLAC__NO_DLL
      LDFLAGS: -static -static-libgcc -static-libstdc++
      PKG_CONFIG_CMD: pkg-config --static
      ARTIFACT_NAME: opus-tools-windows-mingw-static

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool libtool-bin pkg-config make mingw-w64 gettext

      - name: Fetch opus-tools source
        run: |
          set -eux
          git clone https://gitlab.xiph.org/xiph/opus-tools.git
          git -C opus-tools checkout ${{ needs.check-upstream.outputs.opus_tools_hash }}

      - name: Download flac deps
        uses: actions/download-artifact@v4
        with:
          name: flac-deps
          path: ${{ env.PREFIX }}

      - name: Download opus deps
        uses: actions/download-artifact@v4
        with:
          name: opus-deps
          path: ${{ env.PREFIX }}

      - name: Build opus-tools
        run: |
          set -eux
          cd opus-tools
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          PKG_CONFIG="$PKG_CONFIG_CMD" \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            --with-flac \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.PREFIX }}

  update-json:
    needs: [check-upstream, build-opus-tools, build-opus-docs]
    if: needs.check-upstream.outputs.upstream_updated == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download version file
        uses: actions/download-artifact@v4
        with:
          name: upstream-version
          path: .github
          
      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .github/upstream-version.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update upstream versions"
            git push
          fi
