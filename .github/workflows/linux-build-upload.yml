name: Build and Upload (Linux MinGW)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.config }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [static, dynamic]
        include:
          - config: static
            host: x86_64-w64-mingw32
            configure_args: --enable-static --disable-shared
            ldflags: -static -static-libgcc -static-libstdc++
            cflags: -O2 -DFLAC__NO_DLL
            pkg_config_cmd: pkg-config --static
          - config: dynamic
            host: x86_64-w64-mingw32
            configure_args: --enable-shared --disable-static
            ldflags: ""
            cflags: -O2
            pkg_config_cmd: pkg-config

    steps:
    - uses: actions/checkout@v4

    - name: Install MinGW-w64 and Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 autotools-dev autoconf libtool pkg-config wget git make

    - name: Cache Dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: deps
        key: ${{ runner.os }}-mingw-${{ matrix.config }}-deps-v1

    - name: Build Dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        set -e
        mkdir -p deps/src
        cd deps/src
        
        export HOST=${{ matrix.host }}
        export PREFIX=$(pwd)/..
        export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
        export CC=$HOST-gcc
        export CXX=$HOST-g++
        export AR=$HOST-ar
        export RANLIB=$HOST-ranlib
        
        # Helper function
        build_package() {
          url=$1
          name=$2
          args=$3
          if [ ! -d "$name" ]; then
            wget -q $url -O $name.tar.gz
            mkdir -p $name
            tar xf $name.tar.gz -C $name --strip-components=1
          fi
          pushd $name
          ./configure --host=$HOST --prefix=$PREFIX $args
          make -j$(nproc)
          make install
          popd
        }

        # 1. Ogg
        echo "Building Ogg..."
        build_package https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz libogg "${{ matrix.configure_args }}"

        # 2. Opus
        echo "Building Opus..."
        build_package https://downloads.xiph.org/releases/opus/opus-1.4.tar.gz libopus "${{ matrix.configure_args }}"

        # 3. FLAC
        # Disable docs, xmms, cpplibs to speed up and avoid deps
        echo "Building FLAC..."
        build_package https://downloads.xiph.org/releases/flac/flac-1.4.3.tar.xz flac "${{ matrix.configure_args }} --disable-doxygen-docs --disable-xmms-plugin --disable-cpplibs"

        # 4. Opusenc
        echo "Building Opusenc..."
        build_package https://downloads.xiph.org/releases/libopusenc/libopusenc-0.2.1.tar.gz libopusenc "${{ matrix.configure_args }}"

        # 5. Opusfile
        # Disable http to avoid openssl dependency
        echo "Building Opusfile..."
        build_package https://downloads.xiph.org/releases/opusfile/opusfile-0.12.tar.gz opusfile "${{ matrix.configure_args }} --disable-http"

    - name: Prepare Build
      run: |
        export ACLOCAL_PATH=$(pwd)/deps/share/aclocal
        # Ensure aclocal path exists even if empty (e.g. if cache hit but aclocal skipped?)
        # Wait, if cache hit, deps exists.
        mkdir -p $ACLOCAL_PATH
        ./autogen.sh

    - name: Configure
      run: |
        mkdir build-${{ matrix.config }}
        cd build-${{ matrix.config }}
        
        export HOST=${{ matrix.host }}
        export PREFIX=$(pwd)/../deps
        export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
        export PKG_CONFIG="${{ matrix.pkg_config_cmd }}"
        
        echo "Using PKG_CONFIG=$PKG_CONFIG"
        echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
        
        ../configure \
          --host=$HOST \
          --prefix=$(pwd)/install \
          ${{ matrix.configure_args }} \
          LDFLAGS="${{ matrix.ldflags }} -L$PREFIX/lib" \
          CFLAGS="${{ matrix.cflags }} -I$PREFIX/include"

    - name: Build
      run: |
        cd build-${{ matrix.config }}
        make -j$(nproc)

    - name: Install
      run: |
        cd build-${{ matrix.config }}
        make install

    - name: Copy DLLs (Dynamic only)
      if: matrix.config == 'dynamic'
      run: |
        cd build-${{ matrix.config }}/install/bin
        
        # Copy dependencies DLLs
        cp ../../../deps/bin/*.dll . || true
        
        # Copy MinGW runtime DLLs
        # Search in common paths
        search_paths="/usr/lib/gcc/${{ matrix.host }} /usr/${{ matrix.host }}/lib"
        for path in $search_paths; do
            find "$path" -name "*.dll" -exec cp -u {} . \; 2>/dev/null || true
        done
        
        # List copied files
        ls -l *.dll

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: opus-tools-linux-mingw-${{ matrix.config }}
        path: build-${{ matrix.config }}/install/
