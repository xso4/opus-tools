name: Linux MinGW Build Upload

on:
  workflow_dispatch:

jobs:
  build-flac-deps:
    name: Build Flac Deps
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      PREFIX: ${{ github.workspace }}/mingw/static
      SRC_DIR: ${{ github.workspace }}/_deps/static
      PKG_CONFIG_PATH: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      PKG_CONFIG_LIBDIR: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      SHARED_FLAGS: --enable-static --disable-shared
      CFLAGS: -O2 -DFLAC__NO_DLL
      LDFLAGS: -static -static-libgcc -static-libstdc++

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool libtool-bin pkg-config make mingw-w64 git gettext

      - name: Fetch dependency sources
        run: |
          set -eux
          mkdir -p "$SRC_DIR"
          cd "$SRC_DIR"
          git clone https://gitlab.xiph.org/xiph/ogg.git
          git clone https://gitlab.xiph.org/xiph/flac.git

      - name: Build libogg
        run: |
          set -eux
          cd "$SRC_DIR/ogg"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build flac
        run: |
          set -eux
          cd "$SRC_DIR/flac"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Upload flac deps
        uses: actions/upload-artifact@v4
        with:
          name: flac-deps
          path: ${{ env.PREFIX }}

  build-opus-deps:
    name: Build Opus Deps
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      PREFIX: ${{ github.workspace }}/mingw/static
      SRC_DIR: ${{ github.workspace }}/_deps/static
      PKG_CONFIG_PATH: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      PKG_CONFIG_LIBDIR: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      SHARED_FLAGS: --enable-static --disable-shared
      CFLAGS: -O2 -DFLAC__NO_DLL
      LDFLAGS: -static -static-libgcc -static-libstdc++

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool libtool-bin pkg-config make mingw-w64 git gettext

      - name: Fetch dependency sources
        run: |
          set -eux
          mkdir -p "$SRC_DIR"
          cd "$SRC_DIR"
          git clone https://gitlab.xiph.org/xiph/ogg.git
          git clone https://gitlab.xiph.org/xiph/opus.git
          git clone https://gitlab.xiph.org/xiph/opusfile.git
          git clone https://gitlab.xiph.org/xiph/libopusenc.git

      - name: Build libogg
        run: |
          set -eux
          cd "$SRC_DIR/ogg"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build opus
        run: |
          set -eux
          cd "$SRC_DIR/opus"
          ./update_version
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build opusfile
        run: |
          set -eux
          cd "$SRC_DIR/opusfile"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            --disable-http \
            --disable-doc \
            --disable-examples \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Build libopusenc
        run: |
          set -eux
          cd "$SRC_DIR/libopusenc"
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install

      - name: Upload opus deps
        uses: actions/upload-artifact@v4
        with:
          name: opus-deps
          path: ${{ env.PREFIX }}

  build-opus-docs:
    name: Build Opus Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: xiph/opus
          path: opus

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz pandoc groff

      - name: Configure
        working-directory: opus
        run: |
          ./autogen.sh
          ./configure

      - name: Build Documentation
        working-directory: opus
        run: |
          make -C doc
          mkdir -p doc/txt doc/md
          for f in doc/man/man3/*.3; do
            filename=$(basename "$f" .3)
            pandoc -f man -t plain "$f" -o "doc/txt/${filename}.txt"
            pandoc -f man -t markdown "$f" -o "doc/md/${filename}.md"
          done

      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: opus-docs
          path: |
            opus/doc/html/
            opus/doc/txt/
            opus/doc/md/

  build-opus-tools:
    name: Build Opus Tools
    needs: [build-flac-deps, build-opus-deps]
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      PREFIX: ${{ github.workspace }}/mingw/static
      PKG_CONFIG_PATH: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      PKG_CONFIG_LIBDIR: ${{ github.workspace }}/mingw/static/lib/pkgconfig
      SHARED_FLAGS: --enable-static --disable-shared
      CFLAGS: -O2 -DFLAC__NO_DLL
      LDFLAGS: -static -static-libgcc -static-libstdc++
      PKG_CONFIG_CMD: pkg-config --static
      ARTIFACT_NAME: opus-tools-windows-mingw-static

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool libtool-bin pkg-config make mingw-w64 gettext

      - name: Download flac deps
        uses: actions/download-artifact@v4
        with:
          name: flac-deps
          path: ${{ env.PREFIX }}

      - name: Download opus deps
        uses: actions/download-artifact@v4
        with:
          name: opus-deps
          path: ${{ env.PREFIX }}

      - name: Build opus-tools
        run: |
          set -eux
          ./autogen.sh
          BUILD=$(./config.guess)
          mkdir -p build-static
          cd build-static
          CC=${HOST}-gcc \
          CXX=${HOST}-g++ \
          AR=${HOST}-ar \
          RANLIB=${HOST}-ranlib \
          STRIP=${HOST}-strip \
          WINDRES=${HOST}-windres \
          PKG_CONFIG="$PKG_CONFIG_CMD" \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
          PKG_CONFIG_LIBDIR="$PKG_CONFIG_LIBDIR" \
          ../configure \
            --host=$HOST \
            --build=$BUILD \
            --prefix="$PREFIX" \
            --with-flac \
            $SHARED_FLAGS
          make -j"$(nproc)"
          make install


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.PREFIX }}
