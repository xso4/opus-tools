name: Build and Upload

on:
  push:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.build_type }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - build_type: static
            configure_args: --enable-static --disable-shared
            # For static build, we want to link everything statically
            # FLAC__NO_DLL is often needed when linking statically against FLAC on Windows
            cflags: "-O2 -static-libgcc -static-libstdc++ -DFLAC__NO_DLL"
            ldflags: "-static"
            pkg_config: "pkg-config --static"
            artifact_name: opus-tools-windows-static
          - build_type: dynamic
            configure_args: --enable-shared --disable-static
            # For dynamic build, we usually don't force static gcc/stdc++ unless we want to avoid shipping those dlls
            # But to be safe and "dynamic", we can just use defaults or -O2.
            # However, linking against shared libraries of dependencies is the key.
            cflags: "-O2"
            ldflags: ""
            pkg_config: "pkg-config"
            artifact_name: opus-tools-windows-dynamic

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-libogg
            mingw-w64-x86_64-opus
            mingw-w64-x86_64-flac
            mingw-w64-x86_64-libopusenc
            mingw-w64-x86_64-opusfile

      - name: Build Opus-Tools
        run: |
          export PKG_CONFIG="${{ matrix.pkg_config }}"
          export CFLAGS="${{ matrix.cflags }}"
          export LDFLAGS="${{ matrix.ldflags }}"
          
          echo "Building Opus-Tools..."
          ./autogen.sh
          # We don't need to specify PREFIX for dependencies because they are installed in system paths
          # We set prefix for installation to a local directory to easily grab the binaries
          ./configure --prefix=$(pwd)/install_dir ${{ matrix.configure_args }} --with-flac
          make -j$(nproc)
          make install
          
          # Prepare Release
          mkdir release
          cp install_dir/bin/*.exe release/
          
          if [ "${{ matrix.build_type }}" == "dynamic" ]; then
            echo "Copying DLLs for dynamic build..."
            # Copy dependency DLLs
            # We use ldd to find direct dependencies in the mingw64 bin folder
            for exe in release/*.exe; do
              # ldd output example: "libopus-0.dll => /mingw64/bin/libopus-0.dll (0x...)"
              ldd "$exe" | grep '/mingw64/bin' | awk '{print $3}' | while read dll; do
                if [ -f "$dll" ]; then
                   echo "Copying $dll..."
                   cp "$dll" release/
                fi
              done
            done
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: release/
