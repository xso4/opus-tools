name: Build and Upload

on:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.build_type }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [static, dynamic]
        include:
          - build_type: static
            configure_args: --enable-static --disable-shared
            cmake_args: -DBUILD_SHARED_LIBS=OFF
            # For static build, we want to link everything statically
            cflags: "-O2 -static-libgcc -static-libstdc++"
            ldflags: "-static"
            pkg_config: "pkg-config --static"
            artifact_name: opus-tools-windows-static
          - build_type: dynamic
            configure_args: --enable-shared --disable-static
            cmake_args: -DBUILD_SHARED_LIBS=ON
            # For dynamic build, we usually don't force static gcc/stdc++ unless we want to avoid shipping those dlls
            # But to be safe and "dynamic", we can just use defaults or -O2.
            # However, linking against shared libraries of dependencies is the key.
            cflags: "-O2"
            ldflags: ""
            pkg_config: "pkg-config"
            artifact_name: opus-tools-windows-dynamic

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc

      - name: Build Dependencies
        run: |
          mkdir deps
          cd deps
          
          # Clone dependencies
          git clone https://github.com/xiph/ogg.git
          git clone https://github.com/xiph/opus.git
          git clone https://github.com/xiph/flac.git
          git clone https://github.com/xiph/libopusenc.git
          git clone https://github.com/xiph/opusfile.git

          # Setup Environment
          export PREFIX="$(pwd)/../install_dir"
          mkdir -p $PREFIX
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          export CPPFLAGS="-I$PREFIX/include"
          # LDFLAGS will be set during configure/make, but we need to ensure it picks up the prefix
          export LDFLAGS="-L$PREFIX/lib ${{ matrix.ldflags }}"
          export CFLAGS="${{ matrix.cflags }}"
          export CXXFLAGS="${{ matrix.cflags }}"
          
          # Build Ogg
          echo "Building Ogg..."
          cd ogg
          ./autogen.sh
          ./configure --prefix=$PREFIX ${{ matrix.configure_args }}
          make -j$(nproc)
          make install
          cd ..

          # Build Opus
          echo "Building Opus..."
          cd opus
          ./autogen.sh
          ./configure --prefix=$PREFIX ${{ matrix.configure_args }}
          make -j$(nproc)
          make install
          cd ..

          # Build FLAC
          echo "Building FLAC..."
          cd flac
          # FLAC cmake options
          cmake -S . -B build -G "MSYS Makefiles" \
            -DCMAKE_INSTALL_PREFIX=$PREFIX \
            ${{ matrix.cmake_args }} \
            -DBUILD_PROGRAMS=OFF \
            -DBUILD_TESTING=OFF \
            -DINSTALL_MANPAGES=OFF \
            -DWITH_OGG=ON \
            -DOGG_ROOT=$PREFIX
          cmake --build build -- -j$(nproc)
          cmake --build build --target install
          cd ..

          # Build Libopusenc
          echo "Building Libopusenc..."
          cd libopusenc
          ./autogen.sh
          # libopusenc needs opus
          ./configure --prefix=$PREFIX ${{ matrix.configure_args }}
          make -j$(nproc)
          make install
          cd ..

          # Build Opusfile
          echo "Building Opusfile..."
          cd opusfile
          ./autogen.sh
          # opusfile needs opus and ogg
          ./configure --prefix=$PREFIX ${{ matrix.configure_args }} --disable-http
          make -j$(nproc)
          make install
          cd ..

      - name: Build Opus-Tools
        run: |
          export PREFIX="$(pwd)/install_dir"
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          export PKG_CONFIG="${{ matrix.pkg_config }}"
          export CFLAGS="${{ matrix.cflags }} -I$PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib ${{ matrix.ldflags }}"
          
          echo "Building Opus-Tools..."
          ./autogen.sh
          ./configure --prefix=$PREFIX ${{ matrix.configure_args }} --with-flac
          make -j$(nproc)
          
          # Prepare Release
          mkdir release
          cp *.exe release/
          
          if [ "${{ matrix.build_type }}" == "dynamic" ]; then
            echo "Copying DLLs for dynamic build..."
            # Copy dependency DLLs
            cp $PREFIX/bin/*.dll release/ || true
            
            # Copy MinGW runtime DLLs if needed (for fully standalone dynamic build)
            # Find them using ldd or just copy common ones
            # ldd opusenc.exe | grep mingw | awk '{print $3}' | xargs -I {} cp {} release/
            for exe in release/*.exe; do
              ldd "$exe" | grep '/mingw64/bin' | awk '{print $3}' | while read dll; do
                cp "$dll" release/
              done
            done
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: release/
